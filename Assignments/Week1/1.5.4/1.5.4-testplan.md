# Test Plan: Checkout Process - Order Review

## Feature Overview
The **Checkout/Order Review Feature** (`OrderReviewClient` component) manages the final stage of the e-commerce flow where users review their cart items, see the total price, and place an order.

### Component Path
- **Frontend:** `src/components/checkout/OrderReviewClient.tsx`
- **Page:** `src/app/checkout/page.tsx`

### Key Flows
1. **Empty Cart** - User navigates to checkout with no items
2. **Order Review** - User reviews items, quantities, and pricing
3. **Successful Order** - User clicks "Place Order", order is created, cart is cleared
4. **Error Handling** - Network errors or validation failures during order placement
5. **Loading States** - Initial load and order placement states

---

## Test Scenarios

### 1. Empty Cart State ✗ Issue Found
**Test ID:** `checkout-empty-cart`  
**Scenario:** User navigates to checkout page without items in cart

**Setup:**
- User session exists
- Cart is empty

**Steps:**
1. Navigate to `/checkout`
2. Wait for page load

**Expected Results:**
- Empty state message displays: "Your cart is empty"
- ShoppingBag icon is visible
- "Continue Shopping" button is present
- "Continue Shopping" button navigates to homepage (/)
- Place Order button is NOT visible

**Assertions:**
```typescript
await expect(page.getByTestId('checkout-cart-empty')).toBeVisible();
await expect(page.getByText('Your cart is empty')).toBeVisible();
await expect(page.getByRole('button', { name: /continue shopping/i })).toBeVisible();
await expect(page.getByTestId('place-order-button')).not.toBeVisible();
```

**Issue Found:** The selector uses regex `name: /continue shopping/i` but the actual button uses `Link` component. Better approach: `getByTestId('continue-shopping-button')` - **but component doesn't have this testid!** Should either add testid to component or use role-based query with more specific text matching.

---

### 2. Order Review Display ✓
**Test ID:** `checkout-order-review-display`  
**Scenario:** User with items in cart sees order review page

**Setup:**
- User session exists
- Cart contains 2 items:
  - Item 1: "Laptop", price: $999.99, quantity: 1
  - Item 2: "Mouse", price: $29.99, quantity: 2

**Steps:**
1. Navigate to `/checkout`
2. Wait for page to fully load

**Expected Results:**
- Page title: "Review Your Order"
- All cart items are displayed with:
  - Product image
  - Product name
  - Quantity
  - Line total (price × quantity)
- Subtotal displayed correctly: $1,059.97
- Shipping shown as "Free"
- Total displayed correctly: $1,059.97
- "Place Order" button is enabled and visible

**Assertions:**
```typescript
// Verify page structure
await expect(page.getByText('Review Your Order')).toBeVisible();
await expect(page.getByTestId('order-review')).toBeVisible();

// Verify items
const items = page.getByTestId(/^order-item-/);
await expect(items).toHaveCount(2);

// Verify specific item
await expect(page.getByTestId('order-item-name-1')).toContainText('Laptop');
await expect(page.getByTestId('order-item-quantity-1')).toContainText('Quantity: 1');
await expect(page.getByTestId('order-item-total-1')).toContainText('$999.99');

// Verify pricing
await expect(page.getByTestId('order-subtotal-amount')).toContainText('$1,059.97');
await expect(page.getByTestId('order-total-amount')).toContainText('$1,059.97');

// Verify button state
await expect(page.getByTestId('place-order-button')).toBeEnabled();
```

---

### 3. Successful Order Placement ✓
**Test ID:** `checkout-order-placement-success`  
**Scenario:** User successfully places order

**Setup:**
- User session exists
- Cart contains items
- Order API endpoint is mocked to return success

**Steps:**
1. Navigate to `/checkout`
2. Wait for order review to load
3. Click "Place Order" button
4. Wait for success state

**Expected Results:**
- Button shows "Placing Order..." with spinner while request is in flight
- Button is disabled during order placement
- Order API is called with correct payload
- Cart is cleared via `clearCart()` call
- Success toast message appears: "Order placed successfully!"
- Order success page displays with:
  - Green CheckCircle icon
  - "Order Placed Successfully!" heading
  - Success message text
  - "View My Orders" button linking to `/orders`

**Assertions:**
```typescript
const placeButton = page.getByTestId('place-order-button');

// Click and verify loading state
await placeButton.click();
await expect(placeButton).toContainText('Placing Order...');
await expect(placeButton).toBeDisabled();

// Wait for success state
await expect(page.getByTestId('order-placed-success')).toBeVisible({ timeout: 5000 });
await expect(page.getByTestId('order-success-message')).toContainText('Order Placed Successfully!');

// Verify "View My Orders" button
await expect(page.getByTestId('view-orders-button')).toBeVisible();
```

---

### 4. Order Placement Error Handling ✗ Issue Found
**Test ID:** `checkout-order-placement-error`  
**Scenario:** Order placement fails due to network error or API error

**Setup:**
- User session exists
- Cart contains items
- Order API endpoint is mocked to return 500 error

**Steps:**
1. Navigate to `/checkout`
2. Wait for order review to load
3. Click "Place Order" button
4. Wait for error handling

**Expected Results:**
- Button shows loading state initially
- Error toast appears: "Error placing order" with descriptive message
- User remains on checkout page (NOT redirected to success page)
- Cart items are still visible (NOT cleared)
- User can retry placing order
- Console shows error log

**Assertions:**
```typescript
const placeButton = page.getByTestId('place-order-button');

// Mock API to fail
await page.route('*/**/api/**/order', route => 
  route.abort('failed')
);

await placeButton.click();

// Verify error state
await expect(page.getByText(/error placing order/i)).toBeVisible({ timeout: 5000 });

// Verify user can retry
await expect(placeButton).toBeEnabled();
await expect(page.getByTestId('order-review')).toBeVisible();
```

**Issue Found:** The component doesn't explicitly navigate back to cart or show a "Go Back" button on error. If an order placement fails, user is stuck on checkout page. Should either:
1. Add explicit error recovery UI with "Retry" or "Edit Cart" buttons, OR
2. Implement better error messaging that explains next steps

---

### 5. Loading State ✓
**Test ID:** `checkout-loading-state`  
**Scenario:** Initial page load with pending cart data

**Setup:**
- User session exists
- Cart context returns `loading: true`

**Expected Results:**
- Spinner is visible
- Loading message: "Loading your order..."
- Other UI elements are hidden

**Assertions:**
```typescript
await expect(page.getByText('Loading your order...')).toBeVisible();
const spinner = page.locator('[class*="animate-spin"]');
await expect(spinner).toBeVisible();
```

---

### 6. Error State (Data Load Error) ✓
**Test ID:** `checkout-error-state`  
**Scenario:** Cart data fails to load

**Setup:**
- User session exists
- Cart context returns `error: "Failed to fetch cart"`

**Expected Results:**
- Error message displays: "Error loading order: Failed to fetch cart"
- "Retry" button is visible
- Clicking "Retry" reloads the page

**Assertions:**
```typescript
await expect(page.getByText(/error loading order/i)).toBeVisible();
await expect(page.getByRole('button', { name: /retry/i })).toBeVisible();
```

---

### 7. Order Item Image Loading ✓
**Test ID:** `checkout-item-image-loading`  
**Scenario:** Verify product images load correctly with Next.js Image component

**Setup:**
- Cart contains items with image URLs

**Steps:**
1. Navigate to `/checkout`
2. Wait for images to load

**Expected Results:**
- All product images are visible
- Images have correct `alt` text (product name)
- Images use Next.js Image optimization (sizes="64px")
- Data-testid attributes exist for accessibility

**Assertions:**
```typescript
const images = page.locator('[data-testid^="order-item-image-"]');
await expect(images).toHaveCount(2);

// Verify specific image
const laptopImage = page.getByTestId('order-item-image-1');
await expect(laptopImage).toHaveAttribute('alt', 'Laptop');
```

---

### 8. Keyboard Accessibility (Tab Navigation) ✓
**Test ID:** `checkout-keyboard-navigation`  
**Scenario:** User can navigate checkout with keyboard only

**Setup:**
- Cart contains items

**Steps:**
1. Navigate to `/checkout`
2. Press Tab multiple times to navigate through:
   - Product names
   - Quantities
   - "Place Order" button
3. Press Enter on "Place Order" button

**Expected Results:**
- Focus indicator is visible on focusable elements
- "Place Order" button receives focus
- Pressing Enter triggers order placement

**Assertions:**
```typescript
const placeButton = page.getByTestId('place-order-button');
await placeButton.focus();
await expect(placeButton).toBeFocused();

// Simulate Enter key
await page.keyboard.press('Enter');
await expect(placeButton).toContainText('Placing Order...');
```

---

### 9. Price Calculation Accuracy ✗ Issue Found
**Test ID:** `checkout-price-calculation`  
**Scenario:** Verify correct price calculations for multiple items

**Setup:**
- Cart contains 3 items with varying prices and quantities:
  - Item 1: $10.50 × 2 = $21.00
  - Item 2: $25.00 × 1 = $25.00
  - Item 3: $5.99 × 3 = $17.97
- Expected subtotal: $63.97

**Steps:**
1. Navigate to `/checkout`
2. Verify each item's line total
3. Verify subtotal
4. Verify final total

**Expected Results:**
- Each item shows correct line total
- Subtotal is accurate: $63.97
- Total equals subtotal (no tax/additional fees): $63.97

**Assertions:**
```typescript
await expect(page.getByTestId('order-item-total-1')).toContainText('$21.00');
await expect(page.getByTestId('order-item-total-2')).toContainText('$25.00');
await expect(page.getByTestId('order-item-total-3')).toContainText('$17.97');

const subtotal = await page.getByTestId('order-subtotal-amount').textContent();
// Issue: Should verify exact value, not just format
```

**Issue Found:** The component doesn't calculate totals—it relies on `cartTotalAmount` from context. If the context provides wrong data, UI will display wrong totals. **Missing assertions:** Should mock specific cart data and verify the API was called with correct order items payload.

---

## Summary of Issues Found

| Issue # | Location | Severity | Description |
|---------|----------|----------|-------------|
| 1 | Empty cart button selector | Medium | "Continue Shopping" button lacks `data-testid`, forcing use of fragile role-based queries |
| 2 | Error handling flow | High | No "Go Back" button or error recovery UI when order placement fails; user stuck on page |
| 3 | Price validation | Medium | Component doesn't validate totals; should mock cart data in tests and verify payload sent to API |
| 4 | Loading state during retry | Low | After error, clicking retry doesn't reset loading UI state—should add loader during retry attempt |

---

## Integration Points to Test

1. **Cart Context Integration** - Verify correct data retrieval from `useCart()` hook
2. **API Client Integration** - Verify `apiClient.createOrder()` called with correct userId and items
3. **Session Integration** - Verify `getUserId()` returns correct user ID for order
4. **Navigation Integration** - Verify success page links to `/orders` page correctly

---

## Test Data Requirements

```typescript
// Sample cart data for testing
const testCart = {
  items: [
    {
      id: '1',
      name: 'Laptop',
      price: 999.99,
      quantity: 1,
      description: 'High-performance laptop',
      image: '/images/laptop.jpg',
      dataAiHint: 'electronics'
    },
    {
      id: '2',
      name: 'Mouse',
      price: 29.99,
      quantity: 2,
      description: 'Wireless mouse',
      image: '/images/mouse.jpg',
      dataAiHint: 'accessories'
    }
  ],
  totalAmount: 1059.97
};
```

---

## Notes for AI Test Generation

When generating tests for this component in future, consider:
- **Data mocking:** Component relies heavily on context; mock `useCart()` hook with realistic data
- **Async operations:** `handlePlaceOrder()` is async with loading states; use `waitFor()` for assertions
- **Navigation:** Component uses Next.js routing; ensure `useRouter` is properly mocked
- **Toast notifications:** Use `useToast()` hook mock to verify toast messages
- **API calls:** Mock `apiClient.createOrder()` to test both success and error paths
